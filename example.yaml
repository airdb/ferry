log:
  level: info
  backups: 2
  maxsize: 1073741824
  localtime: true
global:
  max_idle_conns: 100
  dial_timeout: 30
  dns_ttl: 1800
  prefer_ipv6: false
  dns_server: https://223.5.5.5/dns-query
upstream:
  torsocks: socks5h://127.0.0.1:9050
  proxy1_example_org: https://user:password@proxy1.example.org:443
  proxy2_example_com: https://foobar:123456@proxy2.example.org:443
https:
  - server:
      - ':443'
    index:
      root: /var/www/html
  - server:
      - example.org:443
    keyfile: example_org.pem
    index:
      root: /var/www/example.org
      body: |
        <html>
        <head><title>Index of {{.Request.URL.Path}}</title></head>
        <body>
        <h1>Index of {{.Request.URL.Path}}</h1><hr><pre><a href="../">../</a>
        {{range .FileInfos -}}
        {{if .IsDir -}}
        <a href="{{.Name}}/">{{.Name}}/</a>                                                  {{.ModTime.Format "02-Jan-2006 15:04"}}       -
        {{else -}}
        <a href="{{.Name}}">{{.Name}}</a>                                                  {{.ModTime.Format "02-Jan-2006 15:04"}}    {{.Size}}
        {{end -}}
        {{end}}</pre><hr></body>
        </html>
        {{tryfiles (print .IndexRoot "/autoindex.html") }}
  - server:
      - ip.example.org:443
    keyfile: example_org.pem
    index:
      headers: |
        content-type: application/json
      body: |
        {"ip":"{{host .Request.RemoteAddr}}","country":"{{country .Request.RemoteAddr}}"}
  - server:
      - demo.example.org:443
    keyfile: /path/to/demo.example.org.key
    certfile: /path/to/fullchain.cer
    prefer_chacha20: true
    forward:
      policy: |
        {{if regexMatch `^(153.3.130.101|153.3.130.102):` .Request.RemoteAddr}}
          bypass_auth
        {{else if contains " YaBrowser/" .Request.UserAgent}}
          bypass_auth
        {{else if contains "ip.phus.lu" .Request.Host}}
          allow_ip
        {{else if .Request.Header.Get "proxy-authorization"}}
          verify_auth
        {{else if all (.Request.ProtoAtLeast 2 0) (eq .Request.TLS.Version 0x0304) (greased .ClientHelloInfo)}}
          require_proxy_auth
        {{else if contains " Chrome/68.0.3440" .Request.UserAgent}}
          require_proxy_auth
        {{else}}
          proxy_pass
        {{end}}
      auth: |
        python auth.py {{.Request.Header.Get "proxy-authorization"}} {{.Request.RemoteAddr}}
      upstream: |
        {{if hasSuffix ".onion" .Request.Host}}torsocks{{end}}
      deny_domains:
        - facebook.com
        - nytimes.com
      speed_limit: 10000000
    pprof:
      enabled: true
    pac:
      enabled: true
    proxy:
      pass: 'http://127.0.0.1:80'
  - server:
      - fly.example.org:443
    prefer_chacha20: true
    forward:
      policy: |
        {{if regexMatch `^(git|curl|node|yarn|Go-http-client|Docker-Client|Homebrew)/` .Request.UserAgent}}
            bypass_auth
        {{else}}
            proxy_pass
        {{end}}
      allow_domains:
        - github.com
http:
  - server:
      - 127.0.0.1:123
      - 169.254.169.254:123
    forward:
      policy: |
        {{if regexMatch `^192\.168\.` .Request.RemoteAddr}}
          bypass_auth
        {{else if regexMatch `\.google|ggpht\.com|gstatic\.com|github` .Request.Host}}
          bypass_auth
        {{else if contains " YaBrowser/" .Request.UserAgent}}
          bypass_auth
        {{else if contains "ip.phus.lu" .Request.Host}}
          allow_ip
        {{else if .Request.Header.Get "proxy-authorization"}}
          verify_auth
        {{else if hasPrefix "Mozilla/" .Request.UserAgent}}
          require_proxy_auth
        {{else}}
          bypass_auth
        {{end}}
      auth: |
        python auth.py {{.Request.Header.Get "proxy-authorization"}} {{.Request.RemoteAddr}}
      upstream: |
        {{if hasPrefix "scholar.google.com" .Request.Host}}
          proxy1_example_org
        {{else if ne (country .Request.Host) "CN"}}
          proxy2_example_com
        {{end}}
    pac:
      enabled: true
    index:
      root: 'C:/Users/phuslu/Desktop'
socks:
  - server:
      - 127.0.0.1:1081
    forward:
      policy: |
        {{if regexMatch `^(153.3.130.101|153.3.130.102):` .Request.RemoteAddr}}
          bypass_auth
        {{else if has (region .Request.RemoteAddr) (list "Jiangsu" "Zhejiang" "Shanghai")}}
          bypass_auth
        {{else if has (city .Request.RemoteAddr) (list "Nanjing" "Shanghai")}}
          bypass_auth
        {{else if eq .Request.Version 5}}
          require_auth
        {{else}}
          reject
        {{end}}
      auth: |
        python auth.py socks "{{.Request.Username}}" "{{.Request.Password}}" {{.Request.RemoteAddr}}
      deny_domains:
        - facebook.com
        - nytimes.com
  - server:
      - 127.0.0.1:1082
    forward:
      policy: |
        {{if eq (city .Request.RemoteAddr) "Nanjing"}}
          bypass_auth
        {{else if not .Request.Host}}
          bypass_auth
        {{else if regexMatch `^(149|91)\.` .Request.Host}}
          bypass_auth
        {{else}}
          reject
        {{end}}
relay:
  - server:
      - ':443'
    to: github.com:443
    upstream: proxy1_example_org
dns:
  - server:
      - ':53'
    upstream:
      - 114.114.114.114
      - 'https://doh.dns.apple.com/dns-query'
